<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Verify Email - Fractal Boston</title>
    <meta
      name="description"
      content="Verify your email subscription to Fractal Boston"
    />
    <meta name="keywords" content="fractal, boston, community, verify, subscribe" />

    <link rel="shortcut icon" href="/img/logo-square.png" />
    <link rel="stylesheet" href="/normalize.css" />
    <link rel="stylesheet" href="/styles.css" />

    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-523DXHRFKR"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-523DXHRFKR");
    </script>
  </head>
  <body>
    <main>
      <header>
        <h1><a href="/">Fractal Boston</a></h1>
        <div class="decorative-element" aria-hidden="true">âœ§</div>
        <div class="floating-shapes" aria-hidden="true">
          <span class="shape shape-1">â—ˆ</span>
          <span class="shape shape-2">âœ¦</span>
          <span class="shape shape-3">â—†</span>
          <span class="shape shape-4">â—¯</span>
          <span class="shape shape-5">âœ§</span>
        </div>
      </header>

      <div class="subscribe-form unsubscribe-page">
        <div id="loadingState" class="unsubscribe-state">
          <p>Verifying your emailâ€¦</p>
        </div>

        <div id="successState" class="unsubscribe-state confirmation-message" style="display: none;">
          <h3>Hooray, our email found you! ðŸŽ‰</h3>
          <p>Welcome to the crew. We're excited to have you.</p>
          <p>Want to connect with the community right away? Hop into our Discord and introduce yourself.</p>
          <div class="submit-button-container">
            <div class="submit-cta">
              <p>
              <a href="https://fractal.boston/discord" target="_blank">
                <button type="button">Join our Discord</button>
              </a>
              </p>
            </div>
          </div>
          <p><a href="/">Back to Fractal Boston</a></p>
        </div>

        <div id="errorState" class="unsubscribe-state" style="display: none;">
          <h3>Something went wrong</h3>
          <p id="errorMessage" class="unsubscribe-error"></p>
          <p>Need help? <a href="https://fractal.boston/discord" target="_blank" rel="noopener noreferrer">Reach out on Discord</a></p>
          <p><a href="/">Back to Fractal Boston</a></p>
        </div>

        <div id="invalidState" class="unsubscribe-state" style="display: none;">
          <h3>Invalid token</h3>
          <p>This verification token is missing or invalid. If you're having trouble, <a href="https://fractal.boston/discord" target="_blank" rel="noopener noreferrer">reach out on Discord</a>.</p>
          <p><a href="/">Back to Fractal Boston</a></p>
        </div>
      </div>
    </main>

    <script>
      (function () {
        // Use localhost API when running locally, otherwise use production
        const isLocalhost = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
        const API_URL = isLocalhost 
          ? "http://localhost:3000/api/verify"
          : "https://fractal-boston-events.vercel.app/api/verify";

        const params = new URLSearchParams(window.location.search);
        const token = params.get("token");

        const loadingState = document.getElementById("loadingState");
        const successState = document.getElementById("successState");
        const errorState = document.getElementById("errorState");
        const invalidState = document.getElementById("invalidState");
        const errorMessage = document.getElementById("errorMessage");

        function show(state) {
          [loadingState, successState, errorState, invalidState].forEach(function (el) {
            el.style.display = "none";
          });
          if (state) state.style.display = "block";
        }

        if (!token || token.trim() === "") {
          show(invalidState);
          return;
        }

        // Automatically verify on page load
        fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: token }),
        })
          .then(function (res) {
            return res.json().then(function (data) {
              return { res: res, data: data };
            });
          })
          .then(function (_ref) {
            var res = _ref.res;
            var data = _ref.data;
            if (data.success === true && data.data && data.data.message) {
              show(successState);
            } else if (data.success === false && data.error) {
              errorMessage.textContent = data.error;
              show(errorState);
            } else if (!res.ok) {
              errorMessage.textContent = (data && data.error) || "Verification failed.";
              show(errorState);
            } else {
              errorMessage.textContent = "An unexpected response was received.";
              show(errorState);
            }
          })
          .catch(function (err) {
            errorMessage.textContent = err.message || "Could not complete verification. Please try again later.";
            show(errorState);
          });
      })();
    </script>
  </body>
</html>
